# v1 Hyperbolic Möbius Transform Utility — Planning Notes

## 0. ゴール
- ポアンカレ円板上の 3 点を別の 3 点へ写す双曲等長（Möbius）変換を数値的に構築する。
- 構築した変換を geodesic（直径／直交円）に適用し、三角形全体を別頂点基準へ再配置できるようにする。
- 既存の `buildHyperbolicTriangle`／描画パイプラインと整合する設計に収める。

## 1. 実装タスク概要
1. **ユーティリティ追加**
   - 変換対象を complex（`Vec2` → `complex`）へ変換するヘルパーを整備。
   - 三点を三点へ写す Möbius 変換を構築する関数を追加（例: `createDiskIsometry(sourceTriple, targetTriple)`）。
       - 手順: `φ` で第 1 点を原点へ→回転で第 2 点を正の実軸へ→ターゲット側で同様→最終的に `T = B^{-1} ∘ A` を返す。
       - 近似誤差やゼロ除算（`1 - ar{a}z`）へのガードを用意。必要なら epsilon を導入。
2. **変換適用関数**
   - 得た変換を `Vec2` に適用する関数（`applyDiskIsometry(vec2, transform)`）を用意。
   - geodesic（直線／円）の記述を変換する関数を追加。
       - 直径: 代表点 2 つを変換 → 再度直径を構築。
       - 直交円: 代表点 2 つを変換 → 単位円と直交する新しい中心＋半径を解く（既存 `solveOrthogonalCircle` を再利用）。
3. **API 整理**
   - 変換を三角形構造 `(vertices, boundaries, angles)` に適用するラッパーを用意。
   - 入れ替えたい頂点の順序（Permutation）を受け取り、転送先頂点集合を設定する関数を設計。

## 2. テスト戦略
- ユニットテスト
    - `createDiskIsometry` が 3 点を所望の 3 点へ 1e-12 程度の精度で写すか確認。
    - geodesic 変換が境界に正しく直交し続けるか（例: 変換後の円が単位円と直交しているか）。
- fast-check（必要なら）
    - ランダムな三角形を生成し、Permutation 後の頂点が差し替わったことを検証。

## 3. 注意点
- 数値安定性: 分母が 0 に近い場合は epsilon を足して発散を防ぐ。
- 共役の取り扱い: SU(1,1) 変換の向きを逆転させたい場合は複素共役を挟む設計余地を残す。
- パフォーマンス: 三角形入れ替え時に毎回変換を計算しても許容だが、キャッシュ層が必要なら後続Issueで検討。

## 4. チェックリスト
- [ ] Möbius 変換構築ユーティリティを実装
- [ ] geodesic への適用関数を実装
- [ ] テスト（ユニット／fast-check）を追加
- [ ] 既存シーン／ユーティリティから利用可能にするためのエクスポート整理
- [ ] DoD: `pnpm biome:check`, `pnpm typecheck`, `pnpm test`

> 実装時に追加の仕様・制約があれば本計画に追記すること。
