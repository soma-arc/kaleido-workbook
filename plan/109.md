# Issue #109: 正方形シーン（4 頂点）を実装する

## Issueスナップショット
- URL: https://github.com/soma-arc/hyperbolic-plane-tile-poc/issues/109
- ラベル想定: type:task, area:ui

### 目的
4 頂点の正多角形を構成する半平面シーンを追加し、各頂点を制御点としてドラッグ可能にする。初期状態は原点中心の正方形とし、ドラッグ後は一般四角形への変形を許容する。

### In / Out
- In: SceneDefinition への正方形シーン追加、共有制御点グラフの構築、頂点ドラッグ時に隣接半平面を更新するロジック、Storybook（Docs/Controls/Play）整備、ユニットテスト追加。
- Out: 5/6 頂点シーンの登録、追加の視覚演出（色分け等）、plane drag の導入。

### 完了条件 (DoD)
- [ ] `SceneDefinition` に正方形シーンが追加され、App/Storybook から選択できる。
- [ ] 頂点ドラッグで当該頂点に接続する 2 枚の半平面だけが更新され、他頂点は維持される。
- [ ] 初期状態は原点中心・既存シーンと同スケールの正方形になる。
- [ ] Storybook Play テストで 1 頂点をドラッグ→隣接半平面が共有頂点を維持する挙動が自動検証される。
- [ ] `pnpm test` / `pnpm typecheck` / `pnpm biome:check` が緑。

### テスト観点
- 頂点制御点を更新した際に共有制御点 ID が崩れないことのユニットテスト。
- Storybook Play で任意の頂点をドラッグし、他頂点が動かないことを確認。

---

## 実装ステップ
1. **共有制御点ユーティリティの導入**
   - `src/geom/` 配下に正多角形の頂点座標と半平面法線を生成する `createRegularPolygonScene`（仮）を実装。
   - 中心=原点、半径は既存ヒンジシーンと同スケールを再利用。
   - 頂点ごとに `controlPointId` を割り当て、隣接半平面に循環参照させるモデルを確立。
2. **SceneDefinition への統合**
   - `TriangleSceneHost` で新ユーティリティを利用する `squareSceneDefinition` を追加。
   - `SceneRegistry` が 4 頂点シーンを一覧に含め、UI から選択可能にする。
3. **ドラッグ挙動の検証と補強**
   - `updateControlPoint` / `euclideanHalfPlaneDrag` が共有頂点に対応しているか確認し、必要なら `recalculateAdjacentHalfPlanes` を追加実装。
   - 共有頂点更新後に対象半平面の法線が正規化されるよう調整。
4. **テスト追加**
   - `tests/unit/geom/` に正方形シーン用のユニットテストを追加し、頂点ドラッグで隣接 2 半平面のみ再計算されることを確認。
   - fast-check プロパティテストで頂点更新後も共有頂点が一貫することを検証（必要に応じて `seed=424242`）。
5. **Storybook 整備**
   - `stories/` に正方形シーンの CSF3 ストーリーを追加し、Docs/Controls を設定。
   - Play テストで 1 頂点をドラッグ → 戻すシナリオを実装して挙動を保証。
6. **残件確認**
   - レンダリングパフォーマンスや UI 追加項目の TODO があれば `TODO.md` / 新 Issue 案へ記録（例: 頂点識別用の配色）。

## リスク・留意点
- 頂点更新時の数値誤差で半平面が逆転しないよう、法線正規化と向きチェックを徹底。
- Storybook Play の pointer 操作が不安定な場合は適切な遅延 (`await`) を挿入する。

## オープンクエスチョン
- なし（ユーザー回答で仕様確定済み）。
