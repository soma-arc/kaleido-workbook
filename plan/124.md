# Issue TBD: WebGL/Canvas 画像保存ボタン計画

## 目的
- サイドバーに配置する画像保存ボタンから現在の描画内容を PNG として保存できるようにし、開発中の可視化結果を迅速に共有可能にする。
- ユーザー操作で選択したオプションに応じて「WebGL 出力のみ」または「WebGL + 2D オーバーレイ（ハンドル付き）」を取得し、用途に合わせたスクリーンショットを提供する。

## 現状整理
- `EuclideanSceneHost` が `StageCanvas`（2D コンテキスト）上に WebGL レンダラー出力とハンドル overlay を合成している。`RenderEngine` は内部に WebGL サブキャンバスを保持するが、外部から直接アクセスする API は未整備。
- 画像エクスポート用途のユーティリティとして `src/render/export.ts` が存在し、単一キャンバスを PNG Data URL に変換できる。
- サイドバー内の UI は `EuclideanSceneHost.controls` ブロックで組み立てられており、保存ボタン追加はここに統合するのが自然。ただしハンドル表示状態（`showHandles`）との整合が必要。
- ハイブリッドモードでのみ WebGL 出力が存在し、Canvas モード時は 2D レンダリングのみで完結する。

## 仕様整理
- サイドバーに「画像保存」セクションを追加し、保存タイプを切り替える UI（ラジオボタンまたはセレクト）と保存実行ボタンを配置する。
- 保存タイプは `webgl`（WebGL のみ）と `composite`（WebGL + 2D overlay/ハンドル）の 2 種類。
- 保存処理は即時ダウンロード開始（例: `download` 属性付きアンカータグ生成）とし、ファイル名は `hyperbolic-<timestamp>-<mode>.png` のように簡潔な実装で良い。
- composite 保存は `StageCanvas` 上に描画済みの結果（WebGL 出力＋ハンドル overlay）をキャプチャするため、追加のハンドル切替処理は不要。WebGL 保存は内部 WebGL キャンバスを直接利用し、ハンドル描画の有無に影響されない。
- Dynamic texture（カメラ入力等）が存在する場合も最新フレームを反映したキャプチャになるよう、保存直前に `renderEuclideanScene` / `renderHyperbolicScene` をワンショットで呼び直す。
- フォールバック: WebGL が無効（`canvas` モードや初期化失敗）時に `webgl` オプションを選んでも composite と同じ結果を返し、UI 上で警告メッセージまたは tooltip を表示しておく。

## 実装ステップ案
1. **RenderEngine 拡張**
   - `RenderEngine` インターフェースに `capture(kind: "composite" | "webgl"): HTMLCanvasElement | null` を追加。
   - `createRenderEngine` 内部で最後に描画した `uiCanvas` と `webgl.canvas` を保持し、`capture` 時に `render/export.ts` のユーティリティを利用して Data URL を生成できる helper を提供（呼び出し側で PNG 化するため Canvas を返す設計も可）。
   - WebGL キャンバス未準備の場合は `null` を返し、呼び出し側で graceful fallback。

2. **保存ユーティリティ追加**
   - `src/ui/utils/download.ts`（仮）に Data URL からファイル保存を行う小ユーティリティを実装。
   - 例外処理・ユーザーキャンセルは不要だが、失敗時には console.warn とトースト用ハンドラを返せるよう関数の戻り値で成否を示す。

3. **EuclideanSceneHost への導線**
   - 保存 UI をサイドバーに追加する `ImageExportControls`（仮）コンポーネントを作成し、モード切替ラジオと保存ボタンを内包。
   - クリック時、選択モードに応じて `renderEngineRef.current?.capture(mode)` を呼び出し、直前に `render...` をワンショットで更新した後に PNG 化してダウンロードする。
   - Hyperbolic シーンでも同じ UI を使えるよう `SceneLayout` 側では常にボタンを表示し、ハンドル未対応シーンでは composite モードを WebGL 出力と同義（差分なし）として扱う。

4. **状態管理**
   - 保存時に非表示だったハンドルを一時的に表示する処理では、`showHandles`・`renderEuclideanScene` の副作用が残らないよう try/finally で管理。
   - `embed` モードでも操作できるよう、ボタン表示条件は `embed` true でも維持（必要なら小型スタイルへ切り替え）。

5. **アクセシビリティ & UX**
   - ボタンには `aria-label` を付与し、実行後に視覚的フィードバック（例: `保存しました` とログ）を行う余地を残す。
   - 選択モード切替はキーボード操作できる form コントロール（ラジオまたは select）で実装。

6. **後方互換**
   - `capture("webgl")` は WebGL キャンバスが無い環境では `null` を返し、呼び出し側で composite にフォールバックする。
   - composite 保存は常に StageCanvas の描画内容をそのまま利用するため、ハンドル表示有無は現状の UI 設定に従う。

## テスト観点
- `render/engine.capture` の単体テスト: JSDOM 上で WebGL 未使用ケースを想定し、`composite` と `webgl` 呼び出しがそれぞれ Canvas を返す（後者は fallback で null）ことを検証。
- `EuclideanSceneHost` の保存処理をモック化テストし、ハンドル非表示時でも composite 保存が handle データを含む描画要求を発行することを確認。
- `download` ユーティリティのテスト: `document.createElement("a")` を spy して `click` が呼ばれるか確認。
- 将来的に Storybook Play test で保存 UI が表示されることを確認するシナリオを追加できるよう、余白を残す。

## ドキュメント & フォローアップ
- `README.md` または `docs/ROADMAP.md` の Now/Next セクションに「画像保存ボタン」タスク追加を検討。
- 実装後は `docs/pr/<Issue>` に保存機能の確認手順（保存モード別）を記載し、スクリーンショットを添付。
- 追加要件（ファイル名カスタム、複数解像度出力など）が浮上した場合は別 Issue で扱う。

## 残課題・次の検討点
- WebGL モードでハンドル線のアンチエイリアス調整が必要かは実装後の画質を確認して判断。
- 保存実行後のトーストや UI フィードバックは MVP 範囲外とし、必要なら新規 Issue 化。
