# Issue #105: ControlPoint グラフ導入と halfPlane ユーティリティの移行

## Issueスナップショット
- URL: https://github.com/soma-arc/hyperbolic-plane-tile-poc/issues/105
- ラベル: type:task, area:core

### 目的
半平面が制御点を共有できるよう ControlPoint グラフを導入し、ヒンジ構造の基盤を整える。

### In / Out
In: ControlPointId 型とテーブル定義, halfPlaneControls API の共有点対応, 単体テスト更新  
Out: UI 層の更新, シーン選択 UI, ヒンジ専用挙動

### 完了条件 (DoD)
- [ ] ControlPoint テーブルと controlPointIds を備えた型定義を追加する
- [ ] controlPointsFromHalfPlanes などの API が共有制御点で round-trip 一致する
- [ ] tests/unit/ui/halfPlaneControlPoints.test.ts を共有点ケース込みで緑化する

### テスト観点
- 共有点を含む round-trip の数値誤差検証
- 固定制御点が updateControlPoint で変化しないことの確認

---

## 実装計画（plan.md 抜粋ベース）

### 現状整理
- `HalfPlaneControlPoints = [Vec2, Vec2]` の前提で、半平面が独立した 2 点を専有している。
- ヒンジシーンでは 2 枚の半平面が制御点を共有する必要があり、現状モデルでは表現できない。
- Storybook や UI 操作ロジックは同じ前提で構築されているが、まずは基盤となるデータモデルの刷新が必要。

### スコープ
1. `src/geom/primitives/halfPlaneControls` の責務を見直し、`ControlPointId` ベースで制御点を参照するモデルを導入する。
2. 半平面⇔制御点の変換ユーティリティを共有ポイント対応に再設計し、round-trip 時に正規化誤差内で一致することを確認する。
3. 既存単体テスト (`tests/unit/ui/halfPlaneControlPoints.test.ts`) を新モデルに合わせて更新し、共有点ケースを追加する。

### 実装ステップ案
1. **型定義の追加**
   - `ControlPointId`（string もしくは number の alias）と `ControlPoint`（座標と固定フラグ）を定義。
   - 半平面定義に `controlPointIds: [ControlPointId, ControlPointId]` を追加し、既存 API との互換層を設ける。

2. **ユーティリティの更新**
   - `controlPointsFromHalfPlanes` を `ControlPoint` テーブルと ID 参照で再実装。
   - `halfPlanesFromControlPoints` や `updateControlPoint` を共有点を考慮した実装へ差し替える。
   - `deriveHalfPlaneFromPoints` / `derivePointsFromHalfPlane` を内部で再利用しつつ、制御点キャッシュ構造を整える。

3. **テスト整備**
   - 既存テストケースを新 API で動作するよう更新。
   - 共有ヒンジを模したケース（2 半平面が同じ ControlPointId を参照）を追加し、round-trip と immutability を検証。

### リスクと対策
- 既存コードの呼び出しが新 API に適応できているか要確認。移行中は互換レイヤ（旧 API 呼び出し→新データモデル）を用意して段階的に差し替える。
- ID 発行方法（UUID / インクリメント等）の決定が必要。短期的には `createControlPointId()` のユーティリティで一元管理する。

### 残オープンクエスチョン
- なし（plan.md 上の疑問は解消済み）。
