# Embed Mode Overlay UI 設計計画

## 目的
- `embed` モードで iframe などから読み込んだ際にも、必要な UI 操作をキャンバスの上部にオーバーレイ表示できるようにする。
- シーンごとに異なる UI を柔軟に配置できる構造へ拡張し、将来のシーン追加に備えた拡張性を確保する。

## 現状整理
- `SceneLayout` は `embed` モード時にキャンバスのみをフル幅表示し、コントロールは一切描画しない設計になっている。
- 通常モード（非 embed）ではサイドバーに `controls` を縦並びに表示しているが、`controls` の中身は `EuclideanSceneHost` などが直接構築している。
- シーン定義 (`SceneDefinition`) は UI のカスタマイズ機構を持っておらず、コントロール構成は主に Host コンポーネントでハードコードされている。

## 仕様方針
- `SceneLayout` を拡張し、`embed` モードではキャンバスと同じラッパー内にオーバーレイ UI を配置できる `overlay` スロットを提供する。
- 各シーン Host（例: `EuclideanSceneHost`, `SphericalSceneHost`）は、既存の `controls` 生成ロジックを流用しつつ、`embed` モード時に独自の `embedControls` を構築する仕組みを導入する。
- `SceneDefinition` または関連コンポーネントに `renderEmbedOverlay?: (context) => ReactNode` のようなフックを追加し、シーンごとの UI バリエーションを注入できるようにする。
- オーバーレイ UI は `position: absolute` とし、デフォルトでは右上に配置。背景半透明、角丸、影などを付与して視認性を確保する。
- オーバーレイの内容はシーンごとに異なるため、Host 側で `scene.embedOverlayFactory?.(props)` のように呼び出して差し込む。未定義の場合は従来どおりコントロール無し。

## 実装ステップ案
1. **SceneLayout 拡張**
   - `SceneLayout` に `overlay?: ReactNode` プロパティを追加。
   - `embed` 分岐で `<div style={{ position: \"relative\" }}>` ラッパーを作成し、キャンバスとオーバーレイを同居させる。
   - オーバーレイ用のスタイルオブジェクト（例: `EMBED_OVERLAY_STYLE`）を追加。背景透過・padding・max-width などを設定。

2. **SceneDefinition/Host 連携**
   - `SceneDefinition` にオプションで `embedOverlayFactory?: (args: EmbedOverlayContext) => ReactNode` を追加。`EmbedOverlayContext` には `scene`, `renderMode`, `controlsState` など必要情報を渡す。
   - `EuclideanSceneHost` / `SphericalSceneHost` で `embed` フラグを判定し、`scene.embedOverlayFactory` がある場合はそれを呼び出してオーバーレイコンテンツを生成。なければ既存 controls を fallback。
   - 既存のサイドバー controls は通常モードでも使うので、`overlay` 用コンテンツはシーンに応じて簡略版を作るイメージ（例: 保存ボタン、シーン切り替え、ラベル等）。

3. **UI コンポーネント設計**
   - オーバーレイ UI を共通化するため `components/EmbedOverlayPanel`（仮）を用意し、背景や余白を統一。
   - シーン固有のコントロールは `scene.embedOverlayFactory` 内で `EmbedOverlayPanel` を組み合わせる形とし、共通のアクセシビリティ属性（`role="toolbar"` など）を付与。

4. **状態共有**
   - オーバーレイに表示する制御（例: 保存ボタン）で既存 state やハンドラを利用できるよう、Host が `embedOverlayFactory` に渡す context に必要な参照（`renderEngineRef`, `scene`, `triangle` 等）を含める。
   - これにより、シーンごとのロジック差異（例: ハンドル制御、カメラ切替）をオーバーレイから呼び出せる。

5. **スタイルとレスポンシブ対応**
   - オーバーレイは画面サイズが小さい場合でも邪魔にならないよう、メディアクエリで自動的に縮小・改行する。当初はシンプルな `flex` レイアウトを採用し、必要に応じて将来拡張。
   - 背景半透明＋blur（`backdrop-filter`）で視認性確保。テーマ色と調和させるため既存の埋め込み背景 `linear-gradient` と衝突しない配色を選択。

6. **アクセシビリティ**
   - オーバーレイがフォーカス可能な要素を含む場合、キーボードで順番に操作できるようにする。オーバーレイ閉鎖は MVP では不要だが、必要なら簡単な close ボタンを規定。
   - 画面リーダー配慮として `aria-label` や `aria-live` を適宜付与。

7. **テストと検証**
   - `tests/unit/ui/app.embed.test.tsx` の Embed シナリオに対し、新たに overlay が描画されていること、シーンによって内容が変わることを検証。
   - Storybook で embed 表示を行う Story を追加し、オーバーレイ UI が想定どおり重なるか確認する。
   - 手動テストでは実際に iframe 埋め込みを行って表示を確認し、背景とのコントラストやクリック領域をチェック。

## フォローアップ
- シーンごとに大幅に異なる UI が必要になった場合、`embedOverlayFactory` の引数を拡張し、カスタム props を渡せるように調整する。
- 追加の操作（例: ツールチップ、ショートカット）を導入する場合は別 Issue を立てて検討。
