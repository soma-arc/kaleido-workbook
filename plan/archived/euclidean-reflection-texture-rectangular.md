# テクスチャ矩形 UI 共通化計画（ドラッグ対応版, 2025-10-19）

## 目的
- 既に導入したテクスチャ矩形設定をユーザーがドラッグ操作で変更できるようにし、最小限の操作体験を提供する。
- 仕組みをジオメトリ共通（Euclidean / Hyperbolic など）で利用できるよう抽象化し、円反転シーン同様に将来的な高機能化へ拡張できる基盤を整える。

## 採用方針（ミニマム）
1. **矩形ヒットのみでドラッグを実現**  
   - 矩形内部をドラッグしたときに中心座標が更新されるシンプルな操作とし、ハンドル類は描画しない。  
   - 回転やサイズ変更は別フェーズの拡張として余地を残す。
2. **共通ロジック化**  
   - `useTextureRectangle`（仮）フックや `TextureRectangleHandle` コンポーネントを追加し、SceneHost ごとに同じ操作を再利用できるようにする。  
   - 描画・ヒットテスト・state 更新を抽象化しておき、ハンドル種別追加や回転対応を後から差し込める構造にする。
3. **SceneHost 統合**  
   - Euclidean 半平面系ホストで新コンポーネントを組み込み、矩形中心をドラッグで変更可能にする。  
   - Hyperbolic など他ジオメトリでも流用できるように、共通コンテキスト／extras を定義。

## タスク分解
1. **共通ユーティリティ整備**  
   - `TextureRectangleState` 型と `useTextureRectangle` フックを `src/ui/scenes` 配下に追加。  
   - シーン初期値（`SceneDefinition.textureRectangle`）から state を生成し、更新時にパイプラインへ反映できるようリスナーを用意。
2. **ドラッグハンドラ実装（最小）**  
   - 矩形内部ヒット時のみドラッグモードに入り、ポインタードラッグで中心座標を更新。描画上のハンドルは追加しない。  
   - ドラッグ可能領域ではカーソルを `grab` / ドラッグ中は `grabbing` に切り替え、操作可否を視覚的に案内。  
   - サイズ・回転は固定のままとし、関連関数は拡張しやすい構造で実装。  
   - クリック判定は矩形ヒットテストに限定し、境界スナップ等は後続フェーズで検討。
3. **SceneHost への組み込み**  
   - EuclideanSceneHost で `useTextureRectangle` を呼び出し、`SceneContextExtras` に `textureRectangleControls` を注入。  
   - HyperbolicSceneHost / SphericalSceneHost にも同フックを組み込めるよう、一旦プレースホルダー呼び出しを用意。  
   - EmbedOverlayPanel やデバッグ用 UI には「矩形ドラッグ有効」の簡易スイッチのみ表示する（詳細 UI は後続）。
4. **パイプライン連携調整**  
   - `euclideanHalfPlanePipeline` と同種の pipeline で state から最新の矩形情報を取得するようにし、デフォルト値 fallback を保持。  
   - 他ジオメトリで流用する際も同 API で渡せるよう共通インターフェースを整理。
5. **テスト追加**  
   - ユニットテスト：フックがドラッグイベントを中心座標更新に変換するか検証。  
   - UI テスト：矩形中心がドラッグで動くことを確認する最小ケースを追加。
6. **ドキュメント更新**  
   - 本計画ファイルと関連ドキュメントに、「現時点では中心ドラッグのみ」「将来的に回転・サイズ変更を追加予定」と明記。

## 拡張余地（将来）
- 角／辺ハンドルによるスケール、回転ハンドル追加。  
- 回転スナップや数値フォーム入力、複数テクスチャ矩形のサポート。  
- URL パラメータやプリセットへの保存。

## 完了条件（DoD）
- 共通フック／コンポーネントで矩形中心がドラッグ操作により更新できる。  
- Euclidean 半平面系シーンでドラッグ結果がパイプラインへ反映され、矩形が移動して描画される。  
- Hyperbolic/Spherical など他ジオメトリでも同フックを呼び出せる構造になっている（最小限の呼び出しプレースホルダーを実装）。  
- lint / typecheck / test が通り、文書も更新済み。
