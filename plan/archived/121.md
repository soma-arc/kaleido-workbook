# Issue #121: 球面モード実装計画（アップデート v2）

## Issueスナップショット
- ラベル想定: type:feature, area:rendering
- 依存確認: 既存のハイパーボリック描画パイプラインとの競合や共通インフラ変更は未確認。着手前に main ブランチの最新化と関連 Issue のステータス確認を行う。

## 目的
- Poincaré 円板 PoC を拡張し、「球面モード」で球面三角形を表示・操作できるようにする。
- 球面描画は WebGL2.0 のフラグメントシェーダでレイトレーシングし、既存 UI からモード切替できるようにする。
- 多様な幾何モード（球面/双曲/ユークリッド）の共存を見据えた設計整理を進める。
- **初期実装では正四面体の頂点を用いた基準球面三角形を描画し、ここから機能拡張する足場を整える。**

## In / Out
- In: 球面三角形モデル、正四面体ベース初期三角形生成、WebGL2.0 フラグメントシェーダ（レイトレ + マルチサンプリング AA）、モード切替 UI、球面三角形編集 UI、Vitest / fast-check / Storybook Docs & Play テスト、ドキュメント更新、OrbitControls 同等操作が可能なカメラクラス（注視点は原点固定）。
- Out: 球面以外の追加幾何モード、高次元拡張、モバイル最適化、CI 設定変更、既存モードへの角度スナップ強化。

## 完了条件 (DoD)
- モード選択 UI で「Spherical」を選ぶと、正四面体由来の基準球面三角形が WebGL2.0 フラグメントシェーダでレイトレーシングされ表示される。
- 球面三角形の3頂点を編集できる UI があり、更新がリアルタイムにシェーダへ反映される。初期状態は正四面体頂点から構成された三角形を再現する。
- 球面モード専用のユニフォーム（単位球半径、視点、ライト、マルチサンプリング設定 等）が型安全に管理される。
- OrbitControls 同等の操作（回転・ズーム・パン制限）を提供するカメラクラスが実装され、注視点は常に原点を向く。球面モードの操作 UI から利用可能。
- マルチサンプリングを用いたアンチエイリアシングが有効になり、設定値がユニフォームで制御できる。
- Vitest / fast-check / Storybook Play / Docs を通じて主要挙動（モード切替・制御点更新・ユニフォーム計算・AA 設定・カメラ操作）が検証される。
- README もしくは docs に球面モードの利用手順・初期構成（正四面体）・カメラ操作ガイド・既知の制限が追記される。

## 仕様確定事項
- 球面三角形は大円弧で構成する。
- 球は原点中心の単位球とする。
- レンダリングは WebGL2.0 で実装する。
- 現行スナップ/角度スナップ機能は継承しない（球面モード独自の挙動とする）。
- 球面モードは他モードの制御点を共有せず、独立した状態を保持。
- マルチサンプリングによるアンチエイリアスを行えるようにする（シェーダ内または FBO 設定で対応）。
- カメラは three.js OrbitControls と同等の操作体系を提供するクラスを新設し、注視点（target）は常に原点で固定。回転は球面座標 (azimuth/elevation)、ズームはカメラ距離スカラー、パンは無効化または原点中心を維持する形で制限。

## 実装ステップ案
1. **既存構造の棚卸し**
   - `src/render` 以下のコンテキスト管理・シェーダ切替構造を調査し、モード追加の拡張ポイントを把握。
   - 現行モード切替（双曲／ユークリッド）のデータフローと UI を整理。
2. **基底実装（正四面体ベース）**
   - `src/geom` に単位球上の正四面体頂点生成ユーティリティ（例: `createTetrahedronTriangle()`）を追加し、初期球面三角形データを供給。
   - 正四面体から導出された 1 面（三角形）を初期状態として返すファクトリを作成。
   - テスト: 正四面体頂点が単位球上にあること、初期三角形の大円弧法線が一致することを検証。
3. **データモデル拡張**
   - `SphericalVertex`, `SphericalTriangle`, `SphericalSceneState` などの型を定義。
   - 球面三角形→シェーダユニフォーム変換ユーティリティを追加し、法線/大円判定を含む計算を実装。
   - fast-check で回転不変性・スケール不変性（単位球）を確認。
4. **カメラクラスの実装**
   - `src/render/camera` 等に OrbitControls 互換のカメラクラス（例: `SphericalOrbitCamera`）を新設。
   - 機能: 原点注視、azimuth/elevation による回転、距離に基づくズーム、パン操作は原点維持で制限。慣性・減衰設定も検討。
   - カメラ状態をレンダリングパイプラインへ統合し、シェーダユニフォームに反映。
   - ユニットテスト: 入力イベント（ドラッグ・ホイール）からカメラ行列生成までを検証。
5. **シェーダ設計・実装**
   - WebGL2.0 フラグメントシェーダで単位球へのレイトレーシングを実装。
   - 球面三角形の可視判定（大円境界）と、Lambert/Phong ベースのライティングを実装。
   - マルチサンプリング（例: 4x）を実現するためのシェーダ内サンプルループまたは FBO 設定を用意。
6. **レンダリングパイプライン統合**
   - レンダリングエンジンに球面モードを追加し、シェーダプログラムとユニフォームをセットアップ。
   - カメラクラスとレンダリングパイプラインを統合し、OrbitControls 風操作が Canvas 上で機能する状態を確認。
   - モード切替時のリソース初期化／破棄、AA 設定トグルを整理。
7. **UI/UX 調整**
   - モード選択 UI に「Spherical」を追加。
   - 球面三角形の頂点操作 UI（頂点座標スライダやドラッグハンドル）を実装。初期値は正四面体。
   - 球面モード専用の Storybook Stories（CSF3）を追加し、Docs/Controls/Play（頂点操作・AA トグル・カメラ操作説明）を整備。
8. **テスト・ドキュメント整備**
   - Vitest: 頂点生成、ユニフォーム計算、カメラ計算、モード切替 reducer。
   - fast-check: 球面三角形の回転不変性。
   - Storybook Play: 頂点操作とカメラ操作の反映確認。
   - README / Docs: 球面モードの概要、正四面体ベース初期状態、カメラ操作ガイド、既知の制約、AA 設定を追記。

## リスク・懸念
- マルチサンプリング実装によるパフォーマンス低下（WebGL2.0 のサンプル数制限に注意）。
- レイトレーシングシェーダおよびカメラクラスの複雑化でデバッグ難度が上がる。
- カメラ操作が既存 UI と異なるためユーザー学習コストが発生。
- 球面→平面投影が不要とはいえ、デバッグ視点の確保が課題。

## 次のアクション
- 上記計画を Issue #121 の正式 DoD として確定（コメントまたは本文更新）。
- main を最新化し、依存 Issue の有無を確認。
- ブランチ命名規約に従って作業ブランチを作成し、TDD で実装を開始。
