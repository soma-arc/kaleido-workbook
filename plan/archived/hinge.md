# 新規シーン実装計画（2枚鏡ヒンジシーンを起点）

## 目的
- Poincaré 円板 PoC の次ステップとして、複数シーン（例: 2枚鏡ヒンジ、4枚鏡半平面など）を切り替えられる土台を整える。
- 第一弾として、2枚の鏡が1つの制御点（ヒンジ）を共有し、各半平面が対側の制御点ドラッグで回転するシーンを実装する。

## 現状整理
- `src/ui/App.tsx` が三角形生成と半平面編集ロジックを一括管理しており、シーンの概念が存在しない。
- 半平面制御点ロジックは `HalfPlaneControlPoints = [Vec2, Vec2]` の固定型で、半平面ごとに独立した2点を前提としている（共有制御点なし）。
- 描画は `RenderEngine` に `halfPlanes`・`handles` を渡す仕組みですでに別シーンにも流用しやすいが、制御点→半平面の変換部分が単純なためヒンジ構造を表現できない。
- Storybook `HalfPlaneStage` も同じ前提で構築されているため、共有制御点が必要なシーンを表現できない。

## リファクタリング検討
1. **シーン管理層の分離**
   - `App` 内の「三角形パラメータ UI」「半平面編集」「描画リクエスト」を分離し、`SceneController`（仮）を介して現在シーンを切り替えられる構造にする。
   - Euclidean/Hyperbolic 切り替えに加え、Euclidean 内で「三角形ベース」「ヒンジシーン」などを選択可能にする UI を追加する（PresetSelector とは独立した仕掛け）。
2. **制御点モデルの一般化**
   - 半平面を `controlPointIds: [idA, idB]` で参照するようにし、`ControlPoint` テーブルで座標を共有管理するデータモデルへ変更。
   - 既存シーン（各半平面が独立2点）の場合は単純に新しいポイントを2つ生成し、ヒンジシーンでは 2 半平面が `idA` を共有する構成にする。
   - `controlPointsFromHalfPlanes` 等のAPIを `HalfPlaneHandleGraph` 的な新設モジュールへ移し、共有点を扱えるように改修。
3. **ドラッグ更新ロジックの再設計**
   - ハンドル移動時、関係する全半平面を再計算するパイプラインが必要。
   - 特に共有ヒンジ点を動かす際に、両方の半平面が同じ基準点を維持したまま回転（or 並進?）する仕様を定義し実装する。
   - 既存の plane drag（法線平行移動）ロジックとの整合性を検討。ヒンジシーンでは plane drag を許可するか？（要確認）。
4. **API/型の整理**
   - `HalfPlaneControlPoints` 型を互換性を保ちつつ、`ControlGraph` に依存するラッパー型へ差し替える。
   - 新旧 API の移行を段階的に行うための `TODO` や deprecation コメントを用意する。

## 実装タスク案（優先順）
1. **データモデル整備**
   - `src/geom/primitives/halfPlaneControls` の責務を再構成し、`ControlPointId` ベースのモデルを導入する。
   - 変換ユーティリティ（半平面⇔制御点）を共有ポイント対応に書き換える。
   - 単体テスト（既存 `halfPlaneControlPoints.test.ts`）を新モデルに合わせて更新、共有点ケースの追加テストを用意。
2. **シーン管理の抽象化**
   - `SceneDefinition`（名前、初期半平面、コントロール設定、UI要素）を定義。
   - `App` を `EuclideanSceneHost` と `HyperbolicSceneHost`（既存三角形機能）に分割し、UI 側でシーン選択を切り出す。
   - 旧三角形シーンを新 API で再実装し、回帰テストを通す。
3. **ヒンジシーンの実装**
   - 初期構成：ヒンジ点（例: 原点）、2つの半平面の自由端点を適切に配置。
   - ドラッグ挙動：
     - 自由端点ドラッグ→ 該当半平面の法線を再計算し、ヒンジを通る直線として更新。
     - ヒンジ点ドラッグ→ 双方の半平面を平行移動するか？（要確認：回転のみ？）
   - 共通ハンドルのアクティブ表示とヒンジ共有を可視化する UI 調整。
   - 主要挙動のユニットテスト／Storybook Play での自動化。
4. **UI 改修**
   - シーン選択 UI を `App` のサイドバーに追加。`TriangleParamForm` 等とのレイアウト調整。
   - ハンドル設定（Spacing等）がシーン依存で上書きできる仕組みを検討。
   - Storybook に新シーンのデモと Play テストを追加。
5. **レンダリング・制御点の同期**
   - `renderEngine` への `handles` 引数が新モデルの配列に対応できることを確認し、必要なギャップ（共有点表示の扱い）を埋める。
   - 必要ならヒンジ点を強調表示するスタイルを追加。
6. **テスト・CI**
   - 既存テスト群の更新（`App` レンダリング、`halfPlaneControlPoints`、`euclideanHalfPlaneDrag`）。
   - 新シーン用の property / unit テスト追加（ヒンジ共有点が維持される、左右半平面が正規化される 等）。
   - Storybook Play test でヒンジシーンのドラッグを検証。

## 不明点・確認事項
1. **ヒンジ制御点の挙動**: ヒンジ自体はユーザーがドラッグ可能ですか？ドラッグ時は両半平面を並進させるのか、原点固定のまま？
固定で問題ありません。
2. **plane drag の許可範囲**: 新シーンで従来の「線を直接ドラッグしてオフセットを変える操作」は必要ですか？
必要ありませんが、後で実装できるような構造にしてください
3. **初期レイアウト**: ヒンジシーンで想定する鏡の角度や位置（例: 90度初期化？）に指定はありますか？
ヒンジは画面中央（原点）においてください。後で調整できるようにします。
角度は９０度
4. **共有ポイントの UI 表現**: ヒンジ点を他のハンドルと色分け／形状変更する要件はありますか？
固定されている場合色を変えてください。
四角に変えられるような仕組みを整えてください。
5. **今後の拡張**: 4枚鏡シーン等では共有点が複数存在する想定か？それともヒンジ1個＋残り独立など、具体像があれば教えてください。
４枚鏡シーンは従来の二つの制御点を持つ半平面が４枚ある構成で、自由に動くようにします。
6. **ストーリーブック要件**: 新シーンの Storybook Docs/Controls/Play で期待する操作シナリオがあれば事前に確認したいです。
制御点単体を動かせること
制御点が固定されているときに動かせないこと


## リスク・留意点
- 既存 API を広範に書き換えるため、段階的リファクタリングとテストの洗い替えが必要。
- 共有制御点導入で `updateControlPoint` 等のパフォーマンスに影響が出る可能性（ただし現在のスケールでは軽微と想定）。
- App UI の構造変更により Triangle パラメータ周りの既存挙動に影響しないよう要回帰確認。

---
上記についてフィードバックをいただければ、仕様確定後にタスクをIssue化／実装着手に進みます。
